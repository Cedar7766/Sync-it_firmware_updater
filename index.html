<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MCU Firmware Uploader</title>
  <style>
    body { font-family: sans-serif; margin: 2em; text-align: center; }
    #progress { width: 100%; margin-top: 1em; }
    #status { margin: 1em 0; color: #333; }
    #filename { font-weight: bold; }
  </style>
</head>
<body>
  <h1>Firmware Uploader</h1>

  <p>Firmware file: <span id="filename">loading...</span></p>

  <button id="connect">Connect & Upload</button>
  <progress id="progress" value="0" max="100" hidden></progress>

  <p id="status"></p>

  <script src="avrbro.browser.js"></script>
  <script>
    const firmwareURL = "./firmware/firmware.hex";
    const firmwareName = firmwareURL.split("/").pop();

    const connectBtn = document.getElementById("connect");
    const progressBar = document.getElementById("progress");
    const status = document.getElementById("status");
    const filename = document.getElementById("filename");

    let firmwareText = null;

    filename.textContent = "loading...";

    // Load the firmware on page load
    fetch(firmwareURL)
      .then(res => {
        if (!res.ok) throw new Error("Failed to fetch firmware.hex");
        return res.text();
      })
      .then(text => {
        firmwareText = text;
        filename.textContent = firmwareName;
        status.textContent = "Firmware loaded";
      })
      .catch(err => {
        status.textContent = "⚠️ " + err.message;
        connectBtn.disabled = true;
      });

    connectBtn.onclick = async () => {
      status.textContent = "";
      progressBar.hidden = false;
      progressBar.value = 0;

      try {
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 1200 });
        await new Promise(r => setTimeout(r, 250));
        await port.close();

        await port.open({ baudRate: 57600 });
        const serial = new AvrSerial(port);
        await serial.open();

        const uploader = new STK500v1(serial);
        await uploader.flashHex(firmwareText, pct => progressBar.value = pct);

        status.textContent = "✅ Upload complete!";
        await serial.close();
      } catch (e) {
        status.textContent = "❌ " + e.message;
      }
    };
  </script>
</body>
</html>
